import{_ as e,Y as o,Z as c,$ as n,a0 as s,a1 as t,a2 as a,E as l}from"./framework-945e1ba3.js";const i={},u=a(`<h1 id="hmdp-redis" tabindex="-1"><a class="header-anchor" href="#hmdp-redis" aria-hidden="true">#</a> hmdp-redis</h1><p>maptobean</p><p>beantomap</p><p>copybean</p><p>copybeanlist</p><h2 id="çŸ­ä¿¡ç™»å½•" tabindex="-1"><a class="header-anchor" href="#çŸ­ä¿¡ç™»å½•" aria-hidden="true">#</a> çŸ­ä¿¡ç™»å½•</h2><p>tomcat sessionid session</p><p>ä¿å­˜éªŒè¯ç </p><p>å‘é€éªŒè¯ç </p><p>æ ¡éªŒéªŒè¯ç </p><h3 id="ç™»å½•æ ¡éªŒ" tabindex="-1"><a class="header-anchor" href="#ç™»å½•æ ¡éªŒ" aria-hidden="true">#</a> ç™»å½•æ ¡éªŒ</h3><p>æ‹¦æˆªå™¨</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–è¯·æ±‚æºå¸¦çš„session</span>
        <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è·å–sessionä¸­çš„ç”¨æˆ·</span>
        <span class="token class-name">UserDTO</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserDTO</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">SystemConstants</span><span class="token punctuation">.</span><span class="token constant">LOGIN_USER_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ç”¨æˆ·ä¸å­˜åœ¨ï¼Œæ‹¦æˆª</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// è¿”å›çŠ¶æ€ï¼Œåº”è¯¥ç»Ÿä¸€å¤„ç†å½¢å¼</span>
            response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å­˜åœ¨ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°ThreadLocal</span>
        <span class="token comment">// todo: ä¸ºä»€ä¹ˆæ”¾ThreadLocalï¼Œä¸ºäº†çº¿ç¨‹å†…</span>
        <span class="token class-name">UserDtoHolder</span><span class="token punctuation">.</span><span class="token function">saveUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ”¾è¡Œ</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¿™ä¸ªåœ¨ä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿ</span>
        <span class="token class-name">UserDtoHolder</span><span class="token punctuation">.</span><span class="token function">removeUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°ThreadLocalï¼ˆä¸ºä»€ä¹ˆï¼‰ç±»ä¼¼contextä¸ºäº†å¯¹è±¡ä¿¡æ¯å…±äº«</p><h3 id="sessionå…±äº«é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#sessionå…±äº«é—®é¢˜" aria-hidden="true">#</a> sessionå…±äº«é—®é¢˜</h3><p>å¤šå°tomcatå¹¶ä¸å…±äº«sessionå­˜å‚¨ç©ºé—´ï¼Œå½“è¯·æ±‚åˆ‡æ¢åˆ°ä¸åŒtomcatæœåŠ¡æ—¶å¯¼è‡´æ•°æ®ä¸¢å¤±é—®é¢˜</p><p>è§£å†³åŠæ³•ï¼Œæ¢ç”¨redis</p><h3 id="redis" tabindex="-1"><a class="header-anchor" href="#redis" aria-hidden="true">#</a> redis</h3><p>æ‹¦æˆªå™¨åŠ @Componentä¸è¡Œï¼Ÿ</p><p>æ‹¦æˆªå™¨é“¾</p><h2 id="å•†æˆ·æŸ¥è¯¢ç¼“å­˜" tabindex="-1"><a class="header-anchor" href="#å•†æˆ·æŸ¥è¯¢ç¼“å­˜" aria-hidden="true">#</a> å•†æˆ·æŸ¥è¯¢ç¼“å­˜</h2><h3 id="ç¼“å­˜æ›´æ–°ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜æ›´æ–°ç­–ç•¥" aria-hidden="true">#</a> ç¼“å­˜æ›´æ–°ç­–ç•¥</h3><p>å†…å­˜æ·˜æ±° è¶…æ—¶å‰”é™¤ ä¸»åŠ¨æ›´æ–°</p><p>ä¸»åŠ¨æ›´æ–°ç­–ç•¥ï¼šåˆ é™¤ç¼“å­˜ã€æ›´æ–°ç¼“å­˜</p><p>ä¿è¯ç¼“å­˜ä¸æ•°æ®åº“æ“ä½œçš„åŒæ—¶æˆåŠŸæˆ–å¤±è´¥</p><p>å•ä½“äº‹åŠ¡ï¼Œåˆ†å¸ƒå¼tcc</p><p>å…ˆæ“ä½œæ•°æ®åº“å†åˆ é™¤ç¼“å­˜</p><p>ï¼ˆå»¶è¿ŸåŒåˆ ï¼Ÿï¼‰</p>`,28),k={href:"https://blog.csdn.net/weixin_63326871/article/details/129313018",target:"_blank",rel:"noopener noreferrer"},d=a(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@JsonDeserialize</span><span class="token punctuation">(</span>using <span class="token operator">=</span> <span class="token class-name">LocalDateTimeDeserializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@JsonSerialize</span><span class="token punctuation">(</span>using <span class="token operator">=</span> <span class="token class-name">LocalDateTimeSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@JsonIgnore</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ç¼“å­˜ç©¿é€" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜ç©¿é€" aria-hidden="true">#</a> ç¼“å­˜ç©¿é€</h3><p>ç¼“å­˜ç©¿é€æ˜¯æŒ‡å®¢æˆ·ç«¯è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜å’Œæ•°æ®åº“éƒ½ä¸å­˜åœ¨</p><p>ç¼“å­˜ç©ºå¯¹è±¡ï¼Œç¼“å­˜ç©ºå€¼åˆ°redisï¼Œä½†æ˜¯å¦‚æœidéƒ½ä¸ä¸€æ ·ï¼Œé€ æˆå†…å­˜æ¶ˆè€—ï¼Œå¯ä»¥è®¾ç½®ttlï¼Œä½†æ˜¯ä¹Ÿä¼šæœ‰çŸ­æœŸæ•°æ®ä¸ä¸€è‡´</p><p>å¸ƒéš†è¿‡æ»¤å™¨ï¼ŒæŸ¥è¯¢redisä¹‹å‰åŠ ä¸€å±‚ï¼Œä¸å­˜åœ¨çš„æ—¶å€™ä¸€å®šä¸å­˜åœ¨ï¼Œå­˜åœ¨çš„æ—¶å€™å¯èƒ½ä¸å­˜åœ¨</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * ç¼“å­˜ç©¿é€
 *
 * <span class="token keyword">@param</span> <span class="token parameter">id</span> åº—é“ºid
 * <span class="token keyword">@return</span> shop
 */</span>
<span class="token keyword">private</span> <span class="token class-name">Shop</span> <span class="token function">queryWithPassThrough</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜</span>
    <span class="token class-name">Shop</span> shop<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        shop <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Shop</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassCastException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¯´æ˜å­˜çš„æ˜¯ç©ºå€¼</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shop <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// redisä¸­æœ‰æ•°æ®ç›´æ¥è¿”å›</span>
        <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æŸ¥æ•°æ®åº“</span>
    shop <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ•°æ®åº“ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shop <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç©ºå€¼å†™å…¥redis</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token constant">CACHE_NULL_TTL</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å­˜åœ¨ï¼Œå†™å…¥redis</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> shop<span class="token punctuation">,</span> <span class="token constant">CACHE_SHOP_TTL</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ç¼“å­˜é›ªå´©" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜é›ªå´©" aria-hidden="true">#</a> ç¼“å­˜é›ªå´©</h3><p>ç¼“å­˜é›ªå´©æ˜¯æŒ‡åŒä¸€æ—¶æ®µå¤§é‡çš„ç¼“å­˜keyå¤±æ•ˆæˆ–è€…redisæœåŠ¡å™¨å®•æœº</p><p>åˆ†æ•£è¿‡æœŸæ—¶é—´ï¼Œæ¯”å¦‚åŠ éšæœºå€¼</p><p>redisé›†ç¾¤</p><p>ç»™ç¼“å­˜é™çº§é™æµç­–ç•¥</p><p>æ·»åŠ å¤šçº§ç¼“å­˜</p><h3 id="ç¼“å­˜å‡»ç©¿" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜å‡»ç©¿" aria-hidden="true">#</a> ç¼“å­˜å‡»ç©¿</h3><p>çƒ­ç‚¹keyï¼Œè¢«é«˜å¹¶å‘è®¿é—®å¹¶ä¸”ç¼“å­˜é‡å»ºä¸šåŠ¡è¾ƒå¤æ‚çš„keyçªç„¶å¤±æ•ˆäº†ï¼Œå¤§é‡è®¿é—®ç›´å‡»æ•°æ®åº“</p><p>äº’æ–¥é”ï¼Œé‡å»ºçº¿ç¨‹è·å–é”ï¼Œå…¶ä»–çº¿ç¨‹è·å–é”å¤±è´¥ä¼‘çœ ä¸€ä¼šå†é‡è¯•ï¼Œæ€§èƒ½å·®</p><p>é€»è¾‘è¿‡æœŸï¼Œï¼ˆçƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸï¼Ÿï¼‰ï¼Œå€¼æ·»åŠ expire: xxxï¼Œå¦‚æœå‘ç°é€»è¾‘æ—¶é—´å·²è¿‡æœŸï¼Œè·å–é”ï¼Œå¼€æ–°çº¿ç¨‹å®Œæˆé‡å»ºï¼Œå†™å…¥ç¼“å­˜é‡ç½®é€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œè‡ªå·±è¿”å›æ—§æ•°æ®ï¼Œå…¶ä»–çº¿ç¨‹è·å–é”å¤±è´¥åœ¨æœªå®Œæˆé‡å»ºæ—¶ä¹Ÿè¿”å›æ—§æ•°æ®ï¼Œæ•°æ®ä¸€è‡´æ€§é—®é¢˜</p><p><img src="https://s2.loli.net/2023/03/31/LndB8PIz2aF9V1C.png" alt="å›¾ 1" loading="lazy"></p><h4 id="äº’æ–¥é”" tabindex="-1"><a class="header-anchor" href="#äº’æ–¥é”" aria-hidden="true">#</a> äº’æ–¥é”</h4><p>setnx keyä¸å­˜åœ¨æ‰å¾€é‡Œé¢å†™ï¼Œkeyå­˜åœ¨æ— æ³•å†™ï¼Œåªèƒ½setå†™</p><p>ä¹Ÿå°±æ˜¯ setnx lock è·å–é”ï¼Œdel lock é‡Šæ”¾é”ï¼Œé˜²æ­¢å‡ºç°é—®é¢˜ï¼Œè®¾ç½®æœ‰æ•ˆæœŸ</p><p>å¯ä»¥æ‹†åˆ†è¿‡ç¨‹<br> 1.æŸ¥è¯¢ç¼“å­˜<br> 2.é‡å»º<br> 2.1è·å–é”<br> 2.2æŸ¥æ•°æ®åº“ï¼Œå†™å›redis<br> 2.3é‡Šæ”¾é”</p>`,21),r={href:"https://blog.csdn.net/kk_lzvvkpj/article/details/129860590",target:"_blank",rel:"noopener noreferrer"},v=a(`<p>postmanå¯ä»¥å¤šçº¿ç¨‹æ¨¡æ‹Ÿé«˜å¹¶å‘å‘èµ·è¯·æ±‚å—ï¼Ÿä¸èƒ½ï¼Œæ˜¯ä¸²è¡Œ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * ç¼“å­˜å‡»ç©¿ï¼Œäº’æ–¥é”
 *
 * <span class="token keyword">@param</span> <span class="token parameter">id</span> åº—é“ºid
 * <span class="token keyword">@return</span> shop
 */</span>
<span class="token keyword">private</span> <span class="token class-name">Shop</span> <span class="token function">queryWithMutex</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜</span>
    <span class="token class-name">Shop</span> shop<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        shop <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Shop</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassCastException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shop <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// redisä¸­æœ‰æ•°æ®ç›´æ¥è¿”å›</span>
        <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ç¼“å­˜é‡å»º</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–äº’æ–¥é”</span>
        <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token constant">LOCK_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ¤æ–­æ˜¯å¦æˆåŠŸ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¤±è´¥ï¼Œä¼‘çœ é‡è¯•</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// todo: æŸ¥è¯¢é‡è¯•ï¼Œç­‰å¾…é‡å»ºå¥½ã€‚æ”¹whileï¼Ÿè‡ªæ—‹ï¼Ÿ</span>
            <span class="token keyword">return</span> <span class="token function">queryWithMutex</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// è·å–é”æˆåŠŸï¼ŒæŸ¥æ•°æ®åº“</span>
        shop <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ¨¡æ‹Ÿé‡å»ºå»¶æ—¶</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shop <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ç©ºå€¼å†™å…¥redis</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token constant">CACHE_NULL_TTL</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å­˜åœ¨ï¼Œå†™å…¥redis</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> shop<span class="token punctuation">,</span> <span class="token constant">CACHE_SHOP_TTL</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// é‡Šæ”¾äº’æ–¥é”</span>
        <span class="token function">unLock</span><span class="token punctuation">(</span><span class="token constant">LOCK_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Boolean</span> lock <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token constant">LOCK_SHOP_TTL</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åº•å±‚æ‹†ç®±æœºåˆ¶ä¼šè°ƒç”¨booleanValue()ä¼šé€ æˆç©ºæŒ‡é’ˆå¼‚å¸¸</span>
    <span class="token keyword">return</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="é€»è¾‘è¿‡æœŸ" tabindex="-1"><a class="header-anchor" href="#é€»è¾‘è¿‡æœŸ" aria-hidden="true">#</a> é€»è¾‘è¿‡æœŸ</h4><p>æ•°æ®<strong>é¢„çƒ­</strong>ï¼Œä¸€å®šéœ€è¦å…ˆé¢„çƒ­çƒ­ç‚¹key</p><p>è·å–é”æˆåŠŸåº”è¯¥å†æ¬¡æ£€æµ‹redisç¼“å­˜æ˜¯å¦è¿‡æœŸã€‚å¦‚æœå­˜åœ¨æ— éœ€é‡å»ºï¼Ÿé‡Šæ”¾é”çš„åŒæ—¶å…¶ä»–çº¿ç¨‹æ‹¿åˆ°äº†é”</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> <span class="token constant">CACHE_REBUILD_EXECUTOR</span> <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
* ç¼“å­˜å‡»ç©¿ï¼Œé€»è¾‘è¿‡æœŸ
*
* <span class="token keyword">@param</span> <span class="token parameter">id</span> åº—é“ºid
* <span class="token keyword">@return</span> shop
*/</span>
<span class="token keyword">private</span> <span class="token class-name">Shop</span> <span class="token function">queryWithLogicalExpire</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜</span>
    <span class="token class-name">RedisData</span> redisData<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        redisData <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RedisData</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassCastException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¯´æ˜å­˜çš„æ˜¯ç©ºå€¼</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>redisData <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ£€æŸ¥é€»è¾‘è¿‡æœŸæ—¶é—´</span>
    <span class="token class-name">LocalDateTime</span> localDateTime <span class="token operator">=</span> redisData<span class="token punctuation">.</span><span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Shop</span><span class="token punctuation">)</span> redisData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æœªè¿‡æœŸ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>localDateTime<span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è¿‡æœŸé‡å»º</span>
    <span class="token comment">// è·å–äº’æ–¥é”</span>
    <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token constant">LOCK_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆ¤æ–­æ˜¯å¦æˆåŠŸ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æˆåŠŸï¼Œåˆ›å»ºæ–°çº¿ç¨‹é‡å»º</span>
        <span class="token constant">CACHE_REBUILD_EXECUTOR</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">saveShopToRedis</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token number">60L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">// é‡Šæ”¾äº’æ–¥é”</span>
                <span class="token function">unLock</span><span class="token punctuation">(</span><span class="token constant">LOCK_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è¿”å›çš„æ˜¯æ—§çš„æ•°æ®ï¼Œå­˜åœ¨æ•°æ®ä¸ä¸€è‡´é—®é¢˜</span>
    <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ç¼“å­˜å·¥å…·å°è£…" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜å·¥å…·å°è£…" aria-hidden="true">#</a> ç¼“å­˜å·¥å…·å°è£…</h3><p><img src="https://s2.loli.net/2023/04/01/LHpdqEbDK8Vzhki.png" alt="å›¾ 2" loading="lazy"></p><h2 id="ä¼˜æƒ åˆ¸ç§’æ€" tabindex="-1"><a class="header-anchor" href="#ä¼˜æƒ åˆ¸ç§’æ€" aria-hidden="true">#</a> ä¼˜æƒ åˆ¸ç§’æ€</h2><h3 id="å…¨å±€å”¯ä¸€id" tabindex="-1"><a class="header-anchor" href="#å…¨å±€å”¯ä¸€id" aria-hidden="true">#</a> å…¨å±€å”¯ä¸€id</h3><blockquote><p>æ„é€ å™¨æ³¨å…¥åŸæ¥ä¸éœ€è¦åŠ  <code>@Autowire</code>ï¼Œåªè¦æ³¨å†Œä¸ºäº†ç»„ä»¶å§ é…åˆå‰ç«¯åŠ å¯†ä¼ è¾“ä¸åç«¯è§£å¯† MVCCæœºåˆ¶?å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶</p></blockquote><p>å…¨å±€idç”Ÿæˆå™¨ï¼Œé«˜å¯ç”¨ã€å”¯ä¸€æ€§ã€é«˜æ€§èƒ½ã€é€’å¢æ€§ã€å®‰å…¨æ€§</p><p>ä¸ä½¿ç”¨è‡ªå¢idï¼Œidè§„å¾‹å¤ªæ˜æ˜¾ï¼Œå—å•è¡¨æ•°æ®é‡çš„é™åˆ¶</p><p>ï¼ˆé›ªèŠ±ç®—æ³•ï¼Ÿï¼‰</p><p>ç¬¦å·ä½ æ—¶é—´æˆ³31bit åºåˆ—å·32bit<br> 0 - 0000000 00000000 00000000 - 00000000 00000000 00000000 00000000</p><ul><li>ç¬¦å·ä½æ°¸è¿œä¸º0</li><li>æ—¶é—´æˆ³ï¼Œä»¥ç§’ä¸ºå•ä½</li><li>ç§’å†…è®¡ç®—å™¨ï¼Œæ”¯æŒæ¯ç§’äº§ç”Ÿ2^32ä¸ªä¸åŒid</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisIdGenerator</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">BEGIN_TIMESTAMP</span> <span class="token operator">=</span> <span class="token number">1672531200L</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SERIAL_BIT</span> <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token class-name">RedisIdGenerator</span><span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate <span class="token operator">=</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">nextId</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyPrefix<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// ç”Ÿæˆæ—¶é—´æˆ³</span>
        <span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> subTimestamp <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">toEpochSecond</span><span class="token punctuation">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span><span class="token constant">UTC</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token constant">BEGIN_TIMESTAMP</span><span class="token punctuation">;</span>

        <span class="token comment">// redisç”Ÿæˆåºåˆ—å·</span>
        <span class="token class-name">String</span> date <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy:MM:dd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> count <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token string">&quot;icr:&quot;</span> <span class="token operator">+</span> keyPrefix <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> date<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ‹¼æ¥å¹¶è¿”å›</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> subTimestamp <span class="token operator">&lt;&lt;</span> <span class="token constant">SERIAL_BIT</span> <span class="token operator">|</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å®ç°ä¼˜æƒ åˆ¸ç§’æ€ä¸‹å•" tabindex="-1"><a class="header-anchor" href="#å®ç°ä¼˜æƒ åˆ¸ç§’æ€ä¸‹å•" aria-hidden="true">#</a> å®ç°ä¼˜æƒ åˆ¸ç§’æ€ä¸‹å•</h3><h3 id="è¶…å–é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#è¶…å–é—®é¢˜" aria-hidden="true">#</a> è¶…å–é—®é¢˜</h3><p><img src="https://s2.loli.net/2023/04/02/WRoV7nNK3zJyLer.png" alt="å›¾ 3" loading="lazy"></p><p>åŠ é”</p><p>æ‚²è§‚é”&amp;ä¹è§‚é”</p><p>ä¹è§‚é”</p><p>ç‰ˆæœ¬å·æ³•</p><p>CASè‡ªæ—‹</p><p>æŸ¥è¯¢æ—¶çš„åº“å­˜å’Œä¿®æ”¹æ—¶çš„åº“å­˜</p>`,26),m={href:"https://blog.csdn.net/zhizhengguan/article/details/122112773",target:"_blank",rel:"noopener noreferrer"},b=a(`<h3 id="ä¸€äººä¸€å•" tabindex="-1"><a class="header-anchor" href="#ä¸€äººä¸€å•" aria-hidden="true">#</a> ä¸€äººä¸€å•</h3><blockquote><p>nginxåä»£</p></blockquote><p>ä½†æ˜¯é›†ç¾¤æ¨¡å¼ä¸‹å•æœºé”synchronizedä¼šå¤±æ•ˆ</p><p>Ideaæ¨¡æ‹Ÿé›†ç¾¤</p><h2 id="åˆ†å¸ƒå¼é”" tabindex="-1"><a class="header-anchor" href="#åˆ†å¸ƒå¼é”" aria-hidden="true">#</a> åˆ†å¸ƒå¼é”</h2><p>åˆ†å¸ƒå¼é”ï¼Œå¤šè¿›ç¨‹å¯è§ã€äº’æ–¥ã€é«˜å¯ç”¨ã€é«˜æ€§èƒ½ã€å®‰å…¨æ€§</p><p>Mysqlã€Redisã€Zookeeper</p><p><img src="https://s2.loli.net/2023/04/03/3hMGo2fRmPl4xZT.png" alt="å›¾ 4" loading="lazy"></p><p>setnxğŸ”’</p><h3 id="åˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#åˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜" aria-hidden="true">#</a> åˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜</h3><p><img src="https://s2.loli.net/2023/04/03/uVyNcYqQZE2vM3d.png" alt="å›¾ 5" loading="lazy"></p><p>é‡Šæ”¾é”æŠŠå…¶ä»–é”åˆ äº†ï¼Œé‡Šæ”¾æ—¶åˆ¤æ–­è‡ªå·±çº¿ç¨‹å’Œé”çš„çº¿ç¨‹æ˜¯ä¸æ˜¯åŒä¸€ä¸ªï¼ˆä½†æ˜¯ä¸åŒè¿›ç¨‹çº¿ç¨‹idå¯èƒ½ä¸€æ ·ï¼ŒåŠ uuidï¼‰</p><p>ä½†æ˜¯åªèƒ½è§£å†³è¯¯åˆ ï¼Œè¿˜æ˜¯æœ‰å¯èƒ½ä¸¤ä¸ªçº¿ç¨‹è¿›å…¥ä¸šåŠ¡ä»£ç </p><h3 id="åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜" aria-hidden="true">#</a> åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜</h3><p>åˆ¤æ–­ä»¥ä¸ºæ˜¯è‡ªå·±çš„é”çš„æ—¶å€™ï¼Œstw</p><p>luaè„šæœ¬è§£å†³å¤šæ¡å‘½ä»¤åŸå­æ€§é—®é¢˜</p><p>redis.call(&#39;set&#39;, &#39;name&#39;, &#39;jack&#39;)</p><p>eval &quot;return redis.call(&#39;set&#39;, &#39;name&#39;, &#39;jack&#39;)&quot; 0ä»£è¡¨éœ€è¦keyç±»å‹å‚æ•°ä¸ªæ•°</p><p>eval &quot;return redis.call(&#39;set&#39;, KEYS[1], ARGV[1])&quot; 1 name rose</p><p>å–å‚æ•° KEYS[] ARGV[] ä¸€å®šå¤§å†™</p><div class="language-lua line-numbers-mode" data-ext="lua"><pre class="language-lua"><code> <span class="token comment">-- æ¯”è¾ƒçº¿ç¨‹æ ‡ç¤ºä¸é”ä¸­çš„æ ‡ç¤ºæ˜¯å¦ä¸€è‡´</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&#39;get&#39;</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
<span class="token keyword">then</span>
    <span class="token comment">-- é‡Šæ”¾é”</span>
    <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&#39;del&#39;</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token keyword">return</span> <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token constant">UNLOCK_SCRIPT</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token punctuation">{</span>
    <span class="token constant">UNLOCK_SCRIPT</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token constant">UNLOCK_SCRIPT</span><span class="token punctuation">.</span><span class="token function">setLocation</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">&quot;unlock.lua&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token constant">UNLOCK_SCRIPT</span><span class="token punctuation">.</span><span class="token function">setResultType</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

stringRedisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token constant">UNLOCK_SCRIPT</span><span class="token punctuation">,</span>
        <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token constant">KEY_PREFIX</span> <span class="token operator">+</span> lockName<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token constant">THREAD_ID_PREFIX</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="redisson" tabindex="-1"><a class="header-anchor" href="#redisson" aria-hidden="true">#</a> Redisson</h2><p>ä¸å¯é‡å…¥ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹æ— æ³•å¤šæ¬¡è·å–åŒä¸€æŠŠé”</p><p>ä¸å¯é‡è¯•ï¼Œè·å–é”åªå°è¯•ä¸€æ¬¡å°±è¿”å›falseï¼Œæ²¡æœ‰é‡è¯•æœºåˆ¶</p><p>è¶…æ—¶é‡Šæ”¾ï¼Œæ‰§è¡Œä¸šåŠ¡æ—¶é—´é•¿å¯¼è‡´é”é‡Šæ”¾</p><p>ä¸»ä»ä¸€è‡´æ€§é—®é¢˜ï¼Œredisé›†ç¾¤ä¸»ä»åŒæ­¥å­˜åœ¨å»¶è¿Ÿï¼Œå†™ä¸»è¯»ä»</p><p>Redissonæ˜¯ä¸€ä¸ªåœ¨redisçš„åŸºç¡€ä¸Šå®ç°çš„javaé©»å†…å­˜æ•°æ®ç½‘æ ¼ï¼ˆin-memory data gridï¼‰ï¼Œåˆ†å¸ƒå¼å·¥å…·é›†åˆï¼ŒåŒ…æ‹¬åˆ†å¸ƒå¼é”</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é…ç½®Redisson</span>
    <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// config.useClusterServers()è®¾ç½®å¤šèŠ‚ç‚¹</span>
    config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;redis://192.168.73.130:6379&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;12345678&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;keyName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å°è¯•è·å–é”</span>
        <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="redissonå¯é‡å…¥é”åŸç†" tabindex="-1"><a class="header-anchor" href="#redissonå¯é‡å…¥é”åŸç†" aria-hidden="true">#</a> Redissonå¯é‡å…¥é”åŸç†</h3><p>å­˜å‚¨å“ˆå¸Œç»“æ„ï¼Œä½†æ˜¯å“ˆå¸Œæ²¡æœ‰setnx</p><p><img src="https://s2.loli.net/2023/04/03/zSsYEUpwjIcrKDV.png" alt="å›¾ 6" loading="lazy"></p><p><img src="https://s2.loli.net/2023/04/03/1nGvdKzmiVaxuI6.png" alt="å›¾ 7" loading="lazy"></p><p>åº•å±‚luaè„šæœ¬æ¥ä¿è¯åŸå­æ€§</p><h3 id="é”é‡è¯•å’Œwatchdogæœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#é”é‡è¯•å’Œwatchdogæœºåˆ¶" aria-hidden="true">#</a> é”é‡è¯•å’Œwatchdogæœºåˆ¶?</h3><p>å‘å¸ƒè®¢é˜…</p><p>çœ‹é—¨ç‹—</p><h2 id="ç§’æ€ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#ç§’æ€ä¼˜åŒ–" aria-hidden="true">#</a> ç§’æ€ä¼˜åŒ–</h2><h3 id="å¼‚æ­¥ç§’æ€æ€è·¯" tabindex="-1"><a class="header-anchor" href="#å¼‚æ­¥ç§’æ€æ€è·¯" aria-hidden="true">#</a> å¼‚æ­¥ç§’æ€æ€è·¯</h3><blockquote><p>luaåº“å­˜æ²¡æœ‰ä¹Ÿä¼šæŠ¥é”™</p></blockquote><p>å…ˆè®©ä½ æŠ¢åˆ°å•ï¼Œç„¶åå†æ…¢æ…¢å¼‚æ­¥æ‰£å‡æ•°æ®åº“</p><p>è®¢å•ç¼“å­˜redis</p><p>set</p><p><img src="https://s2.loli.net/2023/04/04/Xc8ZOjYqMaGRBgp.png" alt="å›¾ 9" loading="lazy"></p><ol><li>æ–°å¢ç§’æ€ä¼˜æƒ åˆ¸çš„åŒæ—¶ï¼Œå°†ä¼˜æƒ åˆ¸ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­</li><li>åŸºäºluaè„šæœ¬ï¼Œåˆ¤æ–­ç§’æ€åº“å­˜ã€ä¸€äººä¸€å•ï¼Œå†³å®šç”¨æˆ·æ˜¯å¦æŠ¢è´­æˆåŠŸ</li><li>å¦‚æœæŠ¢è´­æˆåŠŸï¼Œå°†ä¼˜æƒ åˆ¸idå’Œç”¨æˆ·idå°è£…åå­˜å…¥é˜»å¡é˜Ÿåˆ—</li><li>å¼€å¯çº¿ç¨‹ä»»åŠ¡ï¼Œä¸æ–­ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä¿¡æ¯ï¼Œå®ç°å¼‚æ­¥ä¸‹å•åŠŸèƒ½</li></ol><p>jdkå†…éƒ¨é˜»å¡é˜Ÿåˆ—æœ‰å®‰å…¨é—®é¢˜ç­‰</p><h2 id="redisæ¶ˆæ¯é˜Ÿåˆ—" tabindex="-1"><a class="header-anchor" href="#redisæ¶ˆæ¯é˜Ÿåˆ—" aria-hidden="true">#</a> Redisæ¶ˆæ¯é˜Ÿåˆ—</h2><p>æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰</p><ul><li>æ¶ˆæ¯é˜Ÿåˆ—ï¼šå­˜å‚¨å’Œç®¡ç†æ¶ˆæ¯</li><li>ç”Ÿäº§è€…ï¼šå‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—</li><li>æ¶ˆè´¹è€…ï¼šä»æ¶ˆæ¯é˜Ÿåˆ—è·å–æ¶ˆæ¯å¹¶å¤„ç†æ¶ˆæ¯</li></ul><p>rediså®ç°æ¶ˆæ¯é˜Ÿåˆ—</p><ul><li>list blpush, brpop</li><li>PubSub å‘å¸ƒè®¢é˜…</li><li>Stream</li></ul><h2 id="è¾¾äººæ¢åº—" tabindex="-1"><a class="header-anchor" href="#è¾¾äººæ¢åº—" aria-hidden="true">#</a> è¾¾äººæ¢åº—</h2><h3 id="å‘å¸ƒæ¢åº—ç¬”è®°" tabindex="-1"><a class="header-anchor" href="#å‘å¸ƒæ¢åº—ç¬”è®°" aria-hidden="true">#</a> å‘å¸ƒæ¢åº—ç¬”è®°</h3><p>æ ‡é¢˜æ–‡å­—å›¾ç‰‡</p><p>è¯„è®º</p><p>todo: æ”¹å¯¹è±¡å­˜å‚¨</p><h3 id="æŸ¥çœ‹æ¢åº—ç¬”è®°" tabindex="-1"><a class="header-anchor" href="#æŸ¥çœ‹æ¢åº—ç¬”è®°" aria-hidden="true">#</a> æŸ¥çœ‹æ¢åº—ç¬”è®°</h3><blockquote><p>ä¸éœ€è¦å…ˆç™»å½•æ‰èƒ½çœ‹ç¬”è®°</p></blockquote><h3 id="ç‚¹èµåŠŸèƒ½" tabindex="-1"><a class="header-anchor" href="#ç‚¹èµåŠŸèƒ½" aria-hidden="true">#</a> ç‚¹èµåŠŸèƒ½</h3><blockquote><p>ç‚¹èµè¿™ç§æ•°æ®å’Œè¯„è®ºæ”¾mongodb éœ€è¦çŸ¥é“æ˜¯è°ç‚¹çš„èµè€Œä¸”è¦æŒä¹…åŒ–ä¿å­˜ å¯ä»¥MySQlä¿å­˜ä¸€ä¸ªå…³è”è¡¨ï¼Œï¼ˆç¬¬ä¸€æ¬¡ä»æ•°æ®åº“å–ç‚¹èµidç¼“å­˜ï¼‰ç„¶årediså…ˆç¼“å­˜ï¼Œåœ¨å¼‚æ­¥å®šæ—¶ä»»åŠ¡å†™å…¥æ•°æ®åº“ å¦‚æœç‚¹èµæ•°æ®æ˜¯å…ˆåœ¨å‰ç«¯å¢åŠ ï¼Œæ£€æµ‹åˆ°åˆ·æ–°ï¼Œé€€å‡ºï¼Œä»¥åŠè®¾å®šçš„æ—¶é—´ç­‰æ‰æäº¤ç‚¹èµæ•°æ®</p></blockquote><p>åŒä¸€ä¸ªç”¨æˆ·åªèƒ½ç‚¹èµä¸€æ¬¡ï¼Œå†æ¬¡ç‚¹å‡»åˆ™å–æ¶ˆç‚¹èµ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">isBlogLiked</span><span class="token punctuation">(</span><span class="token class-name">Blog</span> blog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦ç‚¹èµ</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserDtoHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> blogKey <span class="token operator">=</span> <span class="token constant">BLOG_LIKED_KEY</span> <span class="token operator">+</span> blog<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Boolean</span> isMember <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isMember</span><span class="token punctuation">(</span>blogKey<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    blog<span class="token punctuation">.</span><span class="token function">setIsLike</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>isMember<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">likeBlog</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦ç‚¹èµ</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserDtoHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> blogKey <span class="token operator">=</span> <span class="token constant">BLOG_LIKED_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token class-name">Boolean</span> isMember <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isMember</span><span class="token punctuation">(</span>blogKey<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>isMember<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç‚¹èµ</span>
        <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;liked = liked + 1&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>blogKey<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// å†ç‚¹ä¸€æ¬¡å°±æ˜¯ç§»é™¤</span>
        <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;liked = liked - 1&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>blogKey<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="è¯¦æƒ…é¡µç‚¹èµæ•°æ®" tabindex="-1"><a class="header-anchor" href="#è¯¦æƒ…é¡µç‚¹èµæ•°æ®" aria-hidden="true">#</a> è¯¦æƒ…é¡µç‚¹èµæ•°æ®</h3><p>æ ¹æ®ç‚¹èµæ—¶é—´æ’åº</p><p>sortedSetæ— ismember</p><p>æŸ¥åˆ†æ•°åˆ¤æ–­æ˜¯å¦å­˜åœ¨</p><p>zscore</p><p>æ’å</p><p>zrange key 0 4</p><h2 id="å¥½å‹å…³æ³¨" tabindex="-1"><a class="header-anchor" href="#å¥½å‹å…³æ³¨" aria-hidden="true">#</a> å¥½å‹å…³æ³¨</h2><h3 id="å…³æ³¨å’Œå–å…³" tabindex="-1"><a class="header-anchor" href="#å…³æ³¨å’Œå–å…³" aria-hidden="true">#</a> å…³æ³¨å’Œå–å…³</h3><blockquote><p>é€»è¾‘åˆ é™¤,å®šæ—¶ä»»åŠ¡,ç©ºé—²çš„æ—¶å€™åœ¨çœŸæ­£åˆ é™¤</p></blockquote><h3 id="å…±åŒå…³æ³¨" tabindex="-1"><a class="header-anchor" href="#å…±åŒå…³æ³¨" aria-hidden="true">#</a> å…±åŒå…³æ³¨</h3><blockquote><p>ä½†æ˜¯ç›´æ¥æ”¾redisé‡Œæ˜¯ä¸æ˜¯æœ‰ç‚¹ç‰µå¼º</p></blockquote><p>æ±‚äº¤é›†sinter</p><p>æˆ‘è§‰å¾—åº”è¯¥åªè¦ç‚¹å‡»æŸ¥å…±åŒå…³æ³¨çš„æ—¶å€™å–å½“å‰ç”¨æˆ·å’Œå¯¹æ–¹çš„å…³æ³¨å–äº¤é›†ï¼Œå¯ä»¥å€ŸåŠ©redisä¹Ÿå¯ä»¥åªç”¨æ•°æ®åº“è¯­å¥</p><blockquote><p>MySqlæ²¡æœ‰æ±‚äº¤é›†å’Œå·®é›†çš„è¯­å¥ï¼Œåªèƒ½é€šè¿‡unionæ”¹é€ </p></blockquote><h3 id="å…³æ³¨æ¨é€" tabindex="-1"><a class="header-anchor" href="#å…³æ³¨æ¨é€" aria-hidden="true">#</a> å…³æ³¨æ¨é€</h3><blockquote><p>æˆ‘è®°å¾—å“ªé‡Œè®²è¿‡æ¨æ¨¡å¼å’Œæ‹‰æ¨¡å¼ å¦‚æœç”¨æˆ·å–æ¶ˆå…³æ³¨æ€ä¹ˆä¿è¯ç»Ÿä¸€æ€§ï¼Ÿ</p></blockquote><p>feedæµï¼ŒæŠ•å–‚æµï¼Œæ— é™ä¸‹æ‹‰åˆ·æ–°è·å–æ–°çš„ä¿¡æ¯</p><p>Timelineï¼šä¸åšå†…å®¹ç­›é€‰ï¼Œç®€å•æŒ‰ç…§å†…å®¹çš„å‘å¸ƒé¡ºåºæ’åºï¼Œå¸¸ç”¨äºå¥½å‹æˆ–å…³æ³¨ã€‚ä¾‹å¦‚æœ‹å‹åœˆ</p><p>æ™ºèƒ½æ’åºï¼šæ¨é€ç”¨æˆ·æ„Ÿå…´è¶£çš„</p><ul><li>æ‹‰æ¨¡å¼ï¼šè¯»æ‰©æ•£ï¼Œåªæœ‰è¯»çš„æ—¶å€™æ‰æ‹‰å–ï¼Œç„¶åå†æŒ‰ç…§æ—¶é—´æ’åº</li><li>æ¨æ¨¡å¼ï¼šå†™æ‰©æ•£ï¼Œå‘æ¶ˆæ¯ç›´æ¥æ¨é€åˆ°æ‰€æœ‰</li><li>æ¨æ‹‰ç»“åˆï¼šè¯»å†™æ··åˆï¼Œå‘å¸ƒè€…æ ¹æ®ç²‰ä¸æ•°ç›®åˆ†ä¸ºæ¨æ‹‰ï¼Œç²‰ä¸ä¹Ÿæ ¹æ®æ´»è·ƒç¨‹åº¦æ¨æ‹‰</li></ul><h3 id="æ»šåŠ¨åˆ†é¡µæŸ¥è¯¢æ”¶ä»¶ç®±" tabindex="-1"><a class="header-anchor" href="#æ»šåŠ¨åˆ†é¡µæŸ¥è¯¢æ”¶ä»¶ç®±" aria-hidden="true">#</a> æ»šåŠ¨åˆ†é¡µæŸ¥è¯¢æ”¶ä»¶ç®±</h3><blockquote><p>ä¸ç”¨æ—¶é—´æˆ³è€Œä½¿ç”¨é€’å¢generateKey</p></blockquote><h3 id="é™„è¿‘å•†æˆ·åŠŸèƒ½" tabindex="-1"><a class="header-anchor" href="#é™„è¿‘å•†æˆ·åŠŸèƒ½" aria-hidden="true">#</a> é™„è¿‘å•†æˆ·åŠŸèƒ½</h3><p>GEOæ•°æ®ç±»å‹ï¼Œå®é™…ä¸Šæ˜¯zsetï¼Œgeohashè½¬score</p><h3 id="ç”¨æˆ·ç­¾åˆ°" tabindex="-1"><a class="header-anchor" href="#ç”¨æˆ·ç­¾åˆ°" aria-hidden="true">#</a> ç”¨æˆ·ç­¾åˆ°</h3><p>bitMap</p><p>setbit getbit</p><h3 id="uv" tabindex="-1"><a class="header-anchor" href="#uv" aria-hidden="true">#</a> UV</h3><p>UV</p><p>PV</p>`,95);function h(f,g){const p=l("ExternalLinkIcon");return o(),c("div",null,[u,n("p",null,[n("a",k,[s("LocalDateTime"),t(p)])]),d,n("p",null,[s("å¤šçº¿ç¨‹æµ‹è¯•å·¥å…·"),n("a",r,[s("jemeter"),t(p)])]),v,n("blockquote",null,[n("p",null,[s("æ•°æ®åº“updateè¡Œé”"),n("a",m,[s("https://blog.csdn.net/zhizhengguan/article/details/122112773"),t(p)])])]),b])}const w=e(i,[["render",h],["__file","heima-redis.html.vue"]]);export{w as default};
